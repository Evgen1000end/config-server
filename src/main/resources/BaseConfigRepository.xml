<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ru.demkin.esb.configserver.repository.BaseConfigRepository">

  <insert id="saveConfig">
    INSERT INTO postgres.public.configs (value, is_admin, uri, label, username)
    values (#{description.value}, #{isAdmin}, #{description.uri}, #{description.label}, #{username})

  </insert>

  <update id="updateConfig">
    UPDATE
      postgres.public.configs
    SET value    = #{description.value},
        is_admin = #{isAdmin},
        uri      = #{uri},
        label    = #{description.label}
    WHERE ((is_admin = #{isAdmin} and username is null) or username = #{username})
      AND uri = #{uri}
  </update>

  <!--  Методы поиска-->
  <select id="findConfigs" resultType="ru.demkin.esb.configserver.model.ConfigDescriptionDto">
    SELECT *
    FROM postgres.public.configs
    WHERE (is_admin = #{isAdmin} and username is null)
       or username = #{username};
  </select>

  <select id="findConfigsByUrl" resultType="ru.demkin.esb.configserver.model.ConfigDescriptionDto">
    SELECT *
    FROM postgres.public.configs
    WHERE ((is_admin = #{isAdmin} and username is null) or username = #{username})
      AND uri = #{uri};
  </select>

  <delete id="deleteConfig">
    DELETE
    FROM postgres.public.configs
    WHERE ((is_admin = #{isAdmin} and username is null) or username = #{username})
      AND uri = #{uri};
  </delete>

  <delete id="deleteConfigByUri">
    DELETE
    FROM postgres.public.configs
    WHERE uri = #{uri};
  </delete>

  <delete id="deleteConfigByUri2">
    DELETE
    FROM postgres.public.configs
    WHERE uri = #{uri}
      AND is_admin = false;
  </delete>

<!--  Операция работы с группами-->

  <insert id="saveGroup">
    INSERT INTO postgres.public.groups (uri, label)
    values (#{groups.uri}, #{groups.label})

  </insert>

  <update id="updateGroup">
    UPDATE
      postgres.public.groups
    SET   label = #{groups.label}
    WHERE uri = #{uri}
  </update>

  <!--  Методы поиска-->
  <select id="findGroups" resultType="ru.demkin.esb.configserver.model.Group">
    SELECT
      id, uri, label
    FROM
        postgres.public.groups
  </select>

  <select id="findGroupByUrl" resultType="ru.demkin.esb.configserver.model.Group">
    SELECT
      id, uri, label
    FROM
      postgres.public.groups
    WHERE
        uri = #{uri}
  </select>

  <delete id="deleteGroup">
    DELETE
    FROM postgres.public.groups
    WHERE uri = #{uri};
  </delete>

</mapper>
